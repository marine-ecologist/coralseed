---
title: "5. Partitioning variance in coralseed"
author: "George Roff"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{4. Quantifying spatial footprints from coralseed}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

There are two main sources of variability to account for in model outputs: 1) variability from the CONNIE particle tracks, and 2) variability from the model parameters in coralseed. Variance from Bayesian posterior draws is built into coralseed across all steps: competency (time-to-settlement), mortality, landscapes, and larval settlement (see theory). To explore variance between CONNIE model runs and model outputs, we can compare multiple CONNIE inputs while keeping coralseed fixed by using the `set.seed` argument (`set.seed` propagates across all sub-functions for consistency. 

To explore this, we can 1) run the basic function `seed_particles` to interpolate across CONNIE tracks, and 2) use particle_distances to convert the `POINTS` to `MULTILINESTRINGS` for each particle `id` and then measure how far each one has travelled. For example, the following code uses `set.seed` to fix the model parameters and calculate the distances of all 1000 larvae at 60minutes into the simulation:

```{r echo=FALSE}
#devtools::load_all("/Users/rof011/coralseed/coralseed")
library(tidyverse)
library(doParallel)
library(foreach)
library(sf)
library(coralseed)
library(units)

```


```{r, message=FALSE, warning=FALSE, fig.width=6}

mermaid01 <- "/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/conniemodels/Dispersal_SettlementRate/lizard_del_14_1512_sim1/lizard_del_14_1512_sim1/plots/day_12036/run_day_12036_lizard_del_14_1512_sim1_11.json"

seascape <- coralseed::seascape_probability(reefoutline=reef_map, habitat=benthic_map)

output_single <- seed_particles(limit_time = 6.95, input = mermaid01, set.seed=123, set.centre = TRUE, seascape = seascape,  silent = TRUE, competency.function = "exponential", limit.time = 6.95, simulate.mortality = "typeI", simulate.mortality.n = 0)

t1 <- particle_distances(output_single, 60)
hist(t1$t60)
```


To explore this across multiple CONNIE inputs, we can iterate this using parallel processing to explore variability between models across multiple time steps (1 to 6hrs). The example below is for Mermaid cove, a high-retention site in a bay where variance between CONNIE runs would be expected to be low: 

```{r cache=TRUE, warning=FALSE, message=FALSE, fig.width=8}

#### Mermaid
  
Mermaid_filelist <- fs::dir_ls("/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/conniemodels/Dispersal_SettlementRate/", recurse = TRUE, type = "file", glob = "*.json") |> 
  as.character() |> 
  str_subset("11\\.json")

combined_distances <- NULL 

ncores <- detectCores()
cl <- makeCluster(ncores-1)
registerDoParallel(cl)

Mermaid_output <- foreach(i=1:length(Mermaid_filelist), .combine='rbind', .packages=c("tidyr", "coralseed", "forcats")) %dopar% {
  
output_single <- seed_particles(limit_time = 6.95, input = Mermaid_filelist[i], set.seed=123, set.centre = TRUE, seascape = seascape,  silent = TRUE, competency.function = "exponential", limit.time = 6.95, simulate.mortality = "typeI", simulate.mortality.n = 0)

t1 <- particle_distances(output_single, 60)
t2 <- particle_distances(output_single, 120)
t3 <- particle_distances(output_single, 180)
t4 <- particle_distances(output_single, 240)
t5 <- particle_distances(output_single, 300)
t6 <- particle_distances(output_single, 360)

Mermaid_output <- left_join(t1, t2, by="id") %>%
  left_join(., t3, by="id") %>%
  left_join(., t4, by="id") %>%
  left_join(., t5, by="id") %>% 
  left_join(., t6, by="id") |> 
  pivot_longer(-id, values_to = "distance", names_to = "dispersaltime") |> 
  arrange(id, dispersaltime) |> 
  mutate(dispersaltime=as.factor(dispersaltime)) |> 
  mutate(dispersaltime=fct_relevel(dispersaltime, "t60")) |> 
  mutate(sim=as.factor(i))

Mermaid_output

}

stopCluster(cl)

mermaid_distances <- ggplot() + theme_bw() + facet_wrap(~dispersaltime) + ggtitle("high retention - mermaid bay") +
  geom_violin(data=Mermaid_output, aes(sim, distance, fill=sim), alpha=0.6) 

mermaid_distances
#ggsave(mermaid_distances, filename="mermaid_distances.pdf")


```

We can then map individual particle positions for each simulation for a given timepoint. Try this for later in the dispersal model (e.g. 360mins), as it may be expected that particle tracks will become increasingly different between simulations the later particles diverge from the initial release point. 

```{r cache=TRUE, warning=FALSE, message=FALSE, fig.width=10}


Mermaid_filelist <- fs::dir_ls("/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/conniemodels/Dispersal_SettlementRate/", recurse = TRUE, type = "file", glob = "*.json") |> 
  as.character() |> 
  str_subset("11\\.json")

combined_distances <- NULL 

ncores <- detectCores()
cl <- makeCluster(ncores-1)
registerDoParallel(cl)

Mermaid_output_plot <- foreach(i=1:length(Mermaid_filelist), .combine='rbind', .packages=c("tidyr", "coralseed", "forcats")) %dopar% {
  
output_single <- seed_particles(limit_time = 6.95, input = Mermaid_filelist[i], set.seed=123, set.centre = TRUE, seascape = seascape,  silent = TRUE, competency.function = "exponential", limit.time = 6.95, simulate.mortality = "typeI", simulate.mortality.n = 0)

Mermaid_output_sf <- particle_distances(output_single, 120, type="sf") |> 
  mutate(model=as.factor(i)) 


Mermaid_output_sf

}

stopCluster(cl)

#Mermaid_output_plot2 <- Mermaid_output_plot |> filter(model %in% c(1,3,5,7))
library(tmap)

mermaid_2hrs <- tmap::tm_shape(seascape,name = "<b> [Seascape]</b> habitats") + 
  tmap::tm_fill("class",name = "Benthic habitats", palette = c(Plateau = "cornsilk2",
                  `Back Reef Slope` = "darkcyan", `Reef Slope` = "darkseagreen4",
                  `Sheltered Reef Slope` = "darkslategrey", `Inner Reef Flat` = "darkgoldenrod4",
                  `Outer Reef Flat` = "darkgoldenrod2", `Reef Crest` = "coral3"), alpha = 0.6, legend.show=FALSE) +
  tmap::tm_borders(col = "black", lwd = 0.2) +
tm_shape(Mermaid_output_plot, bbox=Mermaid_output_plot, is.master=TRUE) + tm_dots("model", palette="Set2", legend.show=FALSE) +
tm_facets(by="model", free.coords=FALSE, ncol=5)

mermaid_2hrs

#tmap_save(mermaid_2hrs, "mermaid_2hrs.pdf")


```


```{r cache=TRUE, warning=FALSE, message=FALSE, fig.width=8}

#### Palfrey
  
Palfrey_filelist <- fs::dir_ls("/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/conniemodels/Dispersal_SettlementRate/", recurse = TRUE, type = "file", glob = "*.json") |> 
  as.character() |> 
  str_subset("13\\.json")

combined_distances <- NULL 

ncores <- detectCores()
cl <- makeCluster(ncores-1)
registerDoParallel(cl)

Palfrey_output <- foreach(i=1:length(Palfrey_filelist), .combine='rbind', .packages=c("tidyr", "coralseed", "forcats")) %dopar% {
  
output_single <- seed_particles(limit_time = 6.95, input = Mermaid_filelist[i], set.seed=123, set.centre = TRUE, seascape = seascape,  silent = TRUE, competency.function = "exponential", limit.time = 6.95, simulate.mortality = "typeI", simulate.mortality.n = 0)

t1 <- particle_distances(output_single, 60)
t2 <- particle_distances(output_single, 120)
t3 <- particle_distances(output_single, 180)
t4 <- particle_distances(output_single, 240)
t5 <- particle_distances(output_single, 300)
t6 <- particle_distances(output_single, 360)

Palfrey_output_individual <- left_join(t1, t2, by="id") %>%
  left_join(., t3, by="id") %>%
  left_join(., t4, by="id") %>%
  left_join(., t5, by="id") %>% 
  left_join(., t6, by="id") |> 
  pivot_longer(-id, values_to = "distance", names_to = "dispersaltime") |> 
  arrange(id, dispersaltime) |> 
  mutate(dispersaltime=as.factor(dispersaltime)) |> 
  mutate(dispersaltime=fct_relevel(dispersaltime, "t60")) |> 
  mutate(sim=as.factor(i))

Palfrey_output_individual

}

stopCluster(cl)

Palfrey_output_plot <- ggplot() + theme_bw() + facet_wrap(~dispersaltime, scales="free_y") + ggtitle("low retention - palfrey north") +
  geom_violin(data=Palfrey_output, aes(sim, distance, fill=sim), alpha=0.6) 

Palfrey_output_plot

```


```{r cache=TRUE, warning=FALSE, message=FALSE, fig.width=10}


Palfrey_filelist <- fs::dir_ls("/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/conniemodels/Dispersal_SettlementRate/", recurse = TRUE, type = "file", glob = "*.json") |> 
  as.character() |> 
  str_subset("13\\.json")

combined_distances <- NULL 

ncores <- detectCores()
cl <- makeCluster(ncores-1)
registerDoParallel(cl)

Palfrey_output_plot <- foreach(i=1:length(Palfrey_filelist), .combine='rbind', .packages=c("tidyr", "coralseed", "forcats")) %dopar% {
  
output_single <- seed_particles(limit_time = 6.95, input = Palfrey_filelist[i], set.seed=123, set.centre = TRUE, seascape = seascape,  silent = TRUE, competency.function = "exponential", limit.time = 6.95, simulate.mortality = "typeI", simulate.mortality.n = 0)

Palfrey_output_sf <- particle_distances(output_single, 120, type="sf") |> 
  mutate(model=as.factor(i)) 


Palfrey_output_sf

}

stopCluster(cl)

#Mermaid_output_plot2 <- Mermaid_output_plot |> filter(model %in% c(1,3,5,7))
library(tmap)

Palfrey_2hrs <- tmap::tm_shape(seascape,name = "<b> [Seascape]</b> habitats") + 
  tmap::tm_fill("class",name = "Benthic habitats", palette = c(Plateau = "cornsilk2",
                  `Back Reef Slope` = "darkcyan", `Reef Slope` = "darkseagreen4",
                  `Sheltered Reef Slope` = "darkslategrey", `Inner Reef Flat` = "darkgoldenrod4",
                  `Outer Reef Flat` = "darkgoldenrod2", `Reef Crest` = "coral3"), alpha = 0.6, legend.show=FALSE) +
  tmap::tm_borders(col = "black", lwd = 0.2) +
tm_shape(Palfrey_output_plot, bbox=Palfrey_output_plot, is.master=TRUE) + tm_dots("model", palette="Set2", legend.show=FALSE) +
tm_facets(by="model", free.coords=FALSE, ncol=5)

Palfrey_2hrs

#tmap_save(mermaid_2hrs, "mermaid_2hrs.pdf")


```
