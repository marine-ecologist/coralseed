---
title: "CONNIE variability"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{4. Quantifying spatial footprints from coralseed}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}

---



```{r echo=FALSE}
#devtools::load_all("/Users/rof011/coralseed/coralseed")
library(tidyverse)
library(doParallel)
library(foreach)
library(sf)
library(coralseed)
library(units)

```


First read in the seascape and the 100k files for #10

```{r, message=FALSE, warning=FALSE, fig.width=6}


seascape <- coralseed::seascape_probability(reefoutline=reef_map, habitat=benthic_map)

sim1_100k <- st_read("/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/conniemodels/run_day_12036_lizard_del_14_1512_sim1_100K_10.json")
#mermaid01 <- st_read("/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/conniemodels/Dispersal_SettlementRate/lizard_del_14_1512_sim1/lizard_del_14_1512_sim1/plots/day_12036/run_day_12036_lizard_del_14_1512_sim1_11.json")


sample(0:99999, 1000)

input <- sim1_100k |> filter(id %in% sample(0:99999, 1000))


  
output_single <- seed_particles(input = sim1_100k |> filter(id %in% sample(0:99999, 1000)), seascape = seascape, 
                                set.centre = TRUE, format = "json", silent = TRUE, 
                                competency.function = "exponential",  
                                simulate.mortality = "typeI", simulate.mortality.n = 0)




```


Randomly subsample the 100k particles into 1k blocks and calculate the settlement positions, iterate 100 times

```{r cache=TRUE, warning=FALSE, message=FALSE, fig.width=8}

#### Mermaid
  

tic()
nsims=100
ncores <- detectCores()
cl <- makeCluster(ncores-1)
registerDoParallel(cl)

test_output <- foreach(i=1:10, .combine='rbind', .packages=c("tidyr", "coralseed", "forcats")) %dopar% {

output_single <- seed_particles(input = sim1_100k |> filter(id %in% sample(0:99999, 1000)), seascape = seascape, 
                                set.centre = TRUE, format = "json", silent = TRUE, 
                                competency.function = "exponential",  
                                simulate.mortality = "typeI", simulate.mortality.n = 0)

t2 <- particle_distances(output_single, 120)
t4 <- particle_distances(output_single, 240)
t6 <- particle_distances(output_single, 360)
t8 <- particle_distances(output_single, 480)
t10 <- particle_distances(output_single, 600)

main_output <- left_join(t2, t4, by="id") %>%
  left_join(., t6, by="id") %>%
  left_join(., t8, by="id") %>%
  left_join(., t10, by="id")  |> 
  pivot_longer(-id, values_to = "distance", names_to = "dispersaltime") |> 
  arrange(id, dispersaltime) |> 
  mutate(dispersaltime=as.factor(dispersaltime)) |> 
  mutate(dispersaltime=fct_relevel(dispersaltime, "t120")) |> 
  mutate(sim=as.factor(i))

main_output

}

stopCluster(cl)
toc()

mermaid_distances <- ggplot() + theme_bw() + facet_wrap(~dispersaltime, scales="free") + ggtitle("high retention - mermaid bay") +
  geom_violin(data=test_output, aes(sim, distance, fill=sim), alpha=0.6) 

library(ggridges)
mermaid_distances <- ggplot() + theme_bw() + facet_wrap(~dispersaltime, scales="free") + ggtitle("high retention - mermaid bay") +
  geom_density_ridges2(data=test_output, aes(x=sim, y=distance, fill=sim), alpha=0.6) 

mermaid_distances
#ggsave(mermaid_distances, filename="mermaid_distances.pdf")


```

We can then map individual particle positions for each simulation for a given timepoint. Try this for later in the dispersal model (e.g. 360mins), as it may be expected that particle tracks will become increasingly different between simulations the later particles diverge from the initial release point. 

```{r cache=TRUE, warning=FALSE, message=FALSE, fig.width=10}


Mermaid_filelist <- fs::dir_ls("/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/conniemodels/Dispersal_SettlementRate/", recurse = TRUE, type = "file", glob = "*.json") |> 
  as.character() |> 
  str_subset("11\\.json")

combined_distances <- NULL 

ncores <- detectCores()
cl <- makeCluster(ncores-1)
registerDoParallel(cl)

Mermaid_output_plot <- foreach(i=1:length(Mermaid_filelist), .combine='rbind', .packages=c("tidyr", "coralseed", "forcats")) %dopar% {
  
output_single <- seed_particles(limit_time = 6.95, input = Mermaid_filelist[i], set.seed=123, set.centre = TRUE, seascape = seascape,  silent = TRUE, competency.function = "exponential", limit.time = 6.95, simulate.mortality = "typeI", simulate.mortality.n = 0)

Mermaid_output_sf <- particle_distances(output_single, 120, type="sf") |> 
  mutate(model=as.factor(i)) 


Mermaid_output_sf

}

stopCluster(cl)

#Mermaid_output_plot2 <- Mermaid_output_plot |> filter(model %in% c(1,3,5,7))
library(tmap)

mermaid_2hrs <- tmap::tm_shape(seascape,name = "<b> [Seascape]</b> habitats") + 
  tmap::tm_fill("class",name = "Benthic habitats", palette = c(Plateau = "cornsilk2",
                  `Back Reef Slope` = "darkcyan", `Reef Slope` = "darkseagreen4",
                  `Sheltered Reef Slope` = "darkslategrey", `Inner Reef Flat` = "darkgoldenrod4",
                  `Outer Reef Flat` = "darkgoldenrod2", `Reef Crest` = "coral3"), alpha = 0.6, legend.show=FALSE) +
  tmap::tm_borders(col = "black", lwd = 0.2) +
tm_shape(Mermaid_output_plot, bbox=Mermaid_output_plot, is.master=TRUE) + tm_dots("model", palette="Set2", legend.show=FALSE) +
tm_facets(by="model", free.coords=FALSE, ncol=5)

mermaid_2hrs

#tmap_save(mermaid_2hrs, "mermaid_2hrs.pdf")


```


```{r cache=TRUE, warning=FALSE, message=FALSE, fig.width=8}

#### Palfrey
  
Palfrey_filelist <- fs::dir_ls("/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/conniemodels/Dispersal_SettlementRate/", recurse = TRUE, type = "file", glob = "*.json") |> 
  as.character() |> 
  str_subset("13\\.json")

combined_distances <- NULL 

ncores <- detectCores()
cl <- makeCluster(ncores-1)
registerDoParallel(cl)

Palfrey_output <- foreach(i=1:length(Palfrey_filelist), .combine='rbind', .packages=c("tidyr", "coralseed", "forcats")) %dopar% {
  
output_single <- seed_particles(limit_time = 6.95, input = Mermaid_filelist[i], set.seed=123, set.centre = TRUE, seascape = seascape,  silent = TRUE, competency.function = "exponential", limit.time = 6.95, simulate.mortality = "typeI", simulate.mortality.n = 0)

t1 <- particle_distances(output_single, 60)
t2 <- particle_distances(output_single, 120)
t3 <- particle_distances(output_single, 180)
t4 <- particle_distances(output_single, 240)
t5 <- particle_distances(output_single, 300)
t6 <- particle_distances(output_single, 360)

Palfrey_output_individual <- left_join(t1, t2, by="id") %>%
  left_join(., t3, by="id") %>%
  left_join(., t4, by="id") %>%
  left_join(., t5, by="id") %>% 
  left_join(., t6, by="id") |> 
  pivot_longer(-id, values_to = "distance", names_to = "dispersaltime") |> 
  arrange(id, dispersaltime) |> 
  mutate(dispersaltime=as.factor(dispersaltime)) |> 
  mutate(dispersaltime=fct_relevel(dispersaltime, "t60")) |> 
  mutate(sim=as.factor(i))

Palfrey_output_individual

}

stopCluster(cl)

Palfrey_output_plot <- ggplot() + theme_bw() + facet_wrap(~dispersaltime, scales="free_y") + ggtitle("low retention - palfrey north") +
  geom_violin(data=Palfrey_output, aes(sim, distance, fill=sim), alpha=0.6) 

Palfrey_output_plot

```


```{r cache=TRUE, warning=FALSE, message=FALSE, fig.width=10}


Palfrey_filelist <- fs::dir_ls("/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/conniemodels/Dispersal_SettlementRate/", recurse = TRUE, type = "file", glob = "*.json") |> 
  as.character() |> 
  str_subset("13\\.json")

combined_distances <- NULL 

ncores <- detectCores()
cl <- makeCluster(ncores-1)
registerDoParallel(cl)

Palfrey_output_plot <- foreach(i=1:length(Palfrey_filelist), .combine='rbind', .packages=c("tidyr", "coralseed", "forcats")) %dopar% {
  
output_single <- seed_particles(limit_time = 6.95, input = Palfrey_filelist[i], set.seed=123, set.centre = TRUE, seascape = seascape,  silent = TRUE, competency.function = "exponential", limit.time = 6.95, simulate.mortality = "typeI", simulate.mortality.n = 0)

Palfrey_output_sf <- particle_distances(output_single, 120, type="sf") |> 
  mutate(model=as.factor(i)) 


Palfrey_output_sf

}

stopCluster(cl)

#Mermaid_output_plot2 <- Mermaid_output_plot |> filter(model %in% c(1,3,5,7))
library(tmap)

Palfrey_2hrs <- tmap::tm_shape(seascape,name = "<b> [Seascape]</b> habitats") + 
  tmap::tm_fill("class",name = "Benthic habitats", palette = c(Plateau = "cornsilk2",
                  `Back Reef Slope` = "darkcyan", `Reef Slope` = "darkseagreen4",
                  `Sheltered Reef Slope` = "darkslategrey", `Inner Reef Flat` = "darkgoldenrod4",
                  `Outer Reef Flat` = "darkgoldenrod2", `Reef Crest` = "coral3"), alpha = 0.6, legend.show=FALSE) +
  tmap::tm_borders(col = "black", lwd = 0.2) +
tm_shape(Palfrey_output_plot, bbox=Palfrey_output_plot, is.master=TRUE) + tm_dots("model", palette="Set2", legend.show=FALSE) +
tm_facets(by="model", free.coords=FALSE, ncol=5)

Palfrey_2hrs

#tmap_save(mermaid_2hrs, "mermaid_2hrs.pdf")


```
