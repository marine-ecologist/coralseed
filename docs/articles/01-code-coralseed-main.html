<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1. Theory and coral seed code • coralseed</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="1. Theory and coral seed code">
<meta property="og:description" content="coralseed">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">coralseed</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-code-coralseed-main.html">1. Theory and coral seed code</a>
    </li>
    <li>
      <a href="../articles/02-code-coralseed-example.html">2. Example code for running coralseed</a>
    </li>
    <li>
      <a href="../articles/03-code-coralseed-parallel.html">3. Parallel processing with coralseed</a>
    </li>
    <li>
      <a href="../articles/04-coralseed-clamgarden.html">Examples: i) Clam Garden, Lizard Island</a>
    </li>
    <li>
      <a href="../articles/05-coralseed-mermaidbay.html">Examples: ii) Mermaid Bay, Lizard Island</a>
    </li>
    <li>
      <a href="../articles/06-coralseed-palfreyn.html">Examples: iii) Palfrey North, Lizard Island</a>
    </li>
    <li>
      <a href="../articles/07-coralseed-spawnhub.html">Examples: iv) Spawn Hub, Lizard Island</a>
    </li>
    <li>
      <a href="../articles/08-coralseed-watsons.html">Examples: v) Watsons Bay North, Lizard Island</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="01-code-coralseed-main_files/htmlwidgets-1.6.2/htmlwidgets.js"></script><script src="01-code-coralseed-main_files/pymjs-1.3.2/pym.v1.js"></script><script src="01-code-coralseed-main_files/widgetframe-binding-0.3.1/widgetframe.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>1. Theory and coral seed code</h1>
            
            <h4 data-toc-skip class="date">2023-08-23</h4>
      
      
      <div class="hidden name"><code>01-code-coralseed-main.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>coralseed</code> is a spatially explicit probabilistic model
that attempts to quantify the spatial footprint of coral larval
re-seeding from restoration progjects. The model is based on
high-resolution oceanographic models (e.g. CONNIE) that allow for
tracking of individual particles following release through space and
time. By incorporating experimental data on larval behaviour
(competency, habitat specific substrate settlement preferences, swimming
behaviour) settlement probability can be modelled individually for
10<sup>5</sup> - 10<sup>6</sup> larvae. The temporal
dispersal-competency model is then overlaid onto high-resolution habitat
maps (<a href="https://www.allencoralatlas.org" class="external-link">Allen Coral Atlas</a>)
forming a spatially-explicit probabilistic model of settlement following
release of coral larvae.</p>
<p><code>coralseed</code> aims to provide insight into key knowledge
gaps in larval restoration: 1) Where do larvae settle following release?
2) What is the spatial footprint of larval reseeding projects? 3) what
are the likely densities of settled corals? 4) What densities of adult
corals (~10cm size) are produced from reseeding and where are they
located? By varying initial model parameters (e.g. tidal currents, time
of release, larval competency, larval densities, location of release
sites), a simulation modelling approach can be used to quantify the
likely spatial footprint and expected settlement densities, allowing for
optimisation and upscaling of larval reseeding programs on the Great
Barrier Reef and elsewhere.</p>
<p><code>coralseed</code> model is formed from three main sections:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Probabilistic model of larval competency through
time</strong>: the model is parameterised on fine-scale (hourly) data on
coral settlement from wild-captured larvae cultured from the nGBR. The
proportion of larvae settling through time is used to create a Bayesian
probabilistic model of coral settlement in the early time period
following release (0-12hrs), simulating a larval release on reef
substrates.</p></li>
<li><p><strong>Individual-based modelling of larval competency from
dispersal models</strong>: the model leverages a high-resolution
particle tracking model (CONNIE 3) that simulates particle releases from
a point-source larval re-seeding project at Lizard Island (nGBR) in
2022. The model overlays the temporal trajectories from the
probabilistic settlement model on spatial particle tracks to determine
likely settlement times across dispersal trajectories.</p></li>
<li><p><strong>Quantifying spatial mosaics of coral settlement potential
from habitat maps</strong>: By combining high-resolution
satellite-derived maps of coral habitats adjacent to release sites (<a href="https://allencoralatlas.org" class="external-link uri">https://allencoralatlas.org</a>) with larval behaviour
determined from experimental results on settlement preferences and
habitat electivity (e.g. reef crest, reef slope), <code>coralseed</code>
creates spatially explicit predictions of coral settlement across
seascapes.</p></li>
</ol>
<p>Below is the full code and data in <code>R</code> for
<code>coralseed</code> v0.0.0.9 with a (mostly) complete explanation of
how the model functions. <code>coralseed</code> is intended to be
flexible in terms of parameterisation, and can be generalised beyond the
current implementation. The document is in <code>rmarkdown</code> format
(<code>Show</code> / <code>Hide</code> buttons in each code section
expand code and details.</p>
</div>
<div class="section level2">
<h2 id="probabilistic-models-of-larval-competency">1. Probabilistic models of larval competency<a class="anchor" aria-label="anchor" href="#probabilistic-models-of-larval-competency"></a>
</h2>
<p>In larval re-seeding programs, larvae are cultured (either in
aquaculture facilities on land or within culture ponds at sea) and held
until they reach optimal competency (usually determined by either i)
adding <em>n</em> larvae to a tile and quantifying settlement after
10-24hrs, or ii) adding tiles to culture ponds and quantifying the
proportion of larvae that settle after a 24hrs. Competency assays are
repeated daily, and larvae are then released onto the reef after 3-6
days at peak of competency (i.e. highest number of settled larvae) to
maximise the impact of larval reseeding.</p>
<p><code>coralseed</code> defines competency as the duration of time
from release to settlement (from the perspective of larvae at are
<em>n</em> days old following fertilisation). This definition differs
from traditional studies of larval competency (e.g. <a href="https://link.springer.com/content/pdf/10.1007/s003380050193.pdf" class="external-link">Heyward
&amp; Negri 1999</a>, <a href="https://esajournals.onlinelibrary.wiley.com/doi/full/10.1890/10-0143.1" class="external-link">Connolly
&amp; Baird 2010</a>) and that derive larval competency as the
proportion of <em>n</em> larvae settling in a 24hr period across
multiple days. The distinction is important as <code>coralseed</code>
models competency as <em>continuous</em> (i.e. hourly measurements)
individual-based measures within a single cohort, while traditional
studies (and dispersal models) define <em>discrete</em> (daily) measures
across multiple cohorts.</p>
<p>To parameterise <code>coralseed</code>, we ran several experiments at
SeaSims and during coral spawning in the nGBR in 2022. The experiments
tracked settlement of replicated cohorts of larvae (<em>n</em>=100 per
replicate) at hourly timepoints (either 0 to 48hrs at SeaSims or 0-12hrs
with wild spawn). In all experiments, larvae were released into 1 litre
aquaria with a preconditioned settlement tile for substrate.</p>
<p><code>coralseed</code> v0.1 uses the experimental results from
wild-captured coral larvae from Lizard Island in Dec 2022. Briefly, five
replicate pre-conditioned tiles were placed in individual 1 litre
through-flow aquaria (below left) to simulate natural conditions, and
100 larvae added to each container at t0. Tiles were imaged hourly
following larval release using a high-resolution camera (Sony a7R IV)
and in-water probe lens (Laowa 24mm) between t0-6 hrs and again at ~t10
hrs. The proportion of larvae settling through time was quantified by
tracking individual settlement through time (below right).</p>
<p><img src="https://www.dropbox.com/s/3uxt2blloxkgv70/Untitled-1.png?raw=1" width="800"></p>
<div class="section level4">
<h4 id="experimental-results">Experimental results<a class="anchor" aria-label="anchor" href="#experimental-results"></a>
</h4>
<p>Quick summary of key results:</p>
<ul>
<li>Initial settlement is rapid and slows at around 2-3hrs.</li>
<li>Settlement at 10hrs averaged 10 - 30%</li>
<li>Settlement is increasing between 6 and 10hr time points (i.e. not
reached an asymptote by 10hrs)</li>
<li>Predicted settlement densities at 24hrs averaged ~ 0.9 settlers per
cm<sup>2</sup> of available substrate</li>
</ul>
<p>Settlement densities were similar to field experiments after 24hrs
(~1.0 settlers per cm<sup>2</sup>) at Lizard Island in Dec 2022 where
100k larvae were released into 1.5 * 1.5m net enclosures on the
reef.</p>
<!-- <style> -->
<!-- details { -->
<!--     border: 1px solid; -->
<!--     border-radius: 10px; -->
<!--     padding: .1em .5em 0; -->
<!--     text-align: left; -->
<!-- } -->
<!-- </style> -->
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### load data</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/" class="external-link">ggpubr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/slowkow/ggrepel" class="external-link">ggrepel</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  tile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'16E'</span>, <span class="st">'16E'</span>, <span class="st">'16E'</span>, <span class="st">'16E'</span>, <span class="st">'16E'</span>, <span class="st">'16E'</span>, <span class="st">'16E'</span>, <span class="st">'16D'</span>, <span class="st">'16D'</span>, <span class="st">'16D'</span>, <span class="st">'16D'</span>, <span class="st">'16D'</span>, <span class="st">'16D'</span>, <span class="st">'16D'</span>, <span class="st">'16C'</span>, <span class="st">'16C'</span>, <span class="st">'16C'</span>, <span class="st">'16C'</span>, <span class="st">'16C'</span>, <span class="st">'16C'</span>, <span class="st">'16C'</span>, <span class="st">'16B'</span>, <span class="st">'16B'</span>, <span class="st">'16B'</span>, <span class="st">'16B'</span>, <span class="st">'16B'</span>, <span class="st">'16B'</span>, <span class="st">'16A'</span>, <span class="st">'16A'</span>, <span class="st">'16A'</span>, <span class="st">'16A'</span>, <span class="st">'16A'</span>, <span class="st">'16A'</span><span class="op">)</span>,</span>
<span>  minutes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">620</span>, <span class="fl">360</span>, <span class="fl">300</span>, <span class="fl">255</span>, <span class="fl">180</span>, <span class="fl">120</span>, <span class="fl">60</span>, <span class="fl">620</span>, <span class="fl">360</span>, <span class="fl">300</span>, <span class="fl">255</span>, <span class="fl">180</span>, <span class="fl">120</span>, <span class="fl">60</span>, <span class="fl">620</span>, <span class="fl">360</span>, <span class="fl">300</span>, <span class="fl">255</span>, <span class="fl">180</span>, <span class="fl">120</span>, <span class="fl">60</span>, <span class="fl">620</span>, <span class="fl">300</span>, <span class="fl">255</span>, <span class="fl">180</span>, <span class="fl">120</span>, <span class="fl">60</span>, <span class="fl">620</span>, <span class="fl">300</span>, <span class="fl">255</span>, <span class="fl">180</span>, <span class="fl">120</span>, <span class="fl">60</span><span class="op">)</span>,</span>
<span>  count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">22</span>, <span class="fl">20</span>, <span class="fl">16</span>, <span class="fl">15</span>, <span class="fl">12</span>, <span class="fl">6</span>, <span class="fl">4</span>, <span class="fl">25</span>, <span class="fl">23</span>, <span class="fl">23</span>, <span class="fl">22</span>, <span class="fl">19</span>, <span class="fl">16</span>, <span class="fl">7</span>, <span class="fl">28</span>, <span class="fl">23</span>, <span class="fl">21</span>, <span class="fl">21</span>, <span class="fl">17</span>, <span class="fl">14</span>, <span class="fl">6</span>, <span class="fl">21</span>, <span class="fl">12</span>, <span class="fl">12</span>, <span class="fl">9</span>, <span class="fl">6</span>, <span class="fl">2</span>, <span class="fl">8</span>, <span class="fl">7</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  density <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.88</span>, <span class="fl">0.80</span>, <span class="fl">0.64</span>, <span class="fl">0.60</span>, <span class="fl">0.48</span>, <span class="fl">0.24</span>, <span class="fl">0.16</span>, <span class="fl">1.00</span>, <span class="fl">0.92</span>, <span class="fl">0.92</span>, <span class="fl">0.88</span>, <span class="fl">0.76</span>, <span class="fl">0.64</span>, <span class="fl">0.28</span>, <span class="fl">1.12</span>, <span class="fl">0.92</span>, <span class="fl">0.84</span>, <span class="fl">0.84</span>, <span class="fl">0.68</span>, <span class="fl">0.56</span>, <span class="fl">0.24</span>, <span class="fl">0.84</span>, <span class="fl">0.48</span>, <span class="fl">0.48</span>, <span class="fl">0.36</span>, <span class="fl">0.24</span>, <span class="fl">0.08</span>, <span class="fl">0.32</span>, <span class="fl">0.28</span>, <span class="fl">0.24</span>, <span class="fl">0.24</span>, <span class="fl">0.16</span>, <span class="fl">0.08</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>tile<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">tile</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>density<span class="op">=</span><span class="va">count</span><span class="op">/</span><span class="fl">25</span><span class="op">)</span> <span class="co"># divide the cumulative count by area of tile (5x5cm2).</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Number of larvae still swimming (not yet settled)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Hours after release"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="fl">100</span><span class="op">-</span><span class="va">count</span>, color<span class="op">=</span><span class="va">tile</span><span class="op">)</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="fl">100</span><span class="op">-</span><span class="va">count</span>, fill<span class="op">=</span><span class="va">tile</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"black"</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span>, shape<span class="op">=</span><span class="fl">21</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set2"</span>, na.value<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set2"</span>, na.value<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html" class="external-link">geom_label_repel</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">minutes</span><span class="op">)</span>, segment.linetype<span class="op">=</span><span class="fl">3</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="fl">100</span><span class="op">-</span><span class="va">count</span>, label<span class="op">=</span><span class="va">tile</span><span class="op">)</span>, direction<span class="op">=</span><span class="st">"y"</span>, nudge_x<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, <span class="st">'lines'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Settlement density / cm2"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Hours after release"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="va">density</span>, color<span class="op">=</span><span class="va">tile</span><span class="op">)</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="va">density</span>, fill<span class="op">=</span><span class="va">tile</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"black"</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span>, shape<span class="op">=</span><span class="fl">21</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set2"</span>, na.value<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set2"</span>, na.value<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html" class="external-link">geom_label_repel</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">minutes</span><span class="op">)</span>, segment.linetype<span class="op">=</span><span class="fl">3</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="va">density</span>, label<span class="op">=</span><span class="va">tile</span><span class="op">)</span>, direction<span class="op">=</span><span class="st">"y"</span>, nudge_x<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, <span class="st">'lines'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span><span class="va">a</span>,<span class="va">b</span>,ncol<span class="op">=</span><span class="fl">2</span>, labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><img src="01-code-coralseed-main_files/figure-html/unnamed-chunk-2-1.png" width="720" style="display: block; margin: auto auto auto 0;">
</div>
<div class="section level4">
<h4 id="probabilistic-approach-to-determining-competency">Probabilistic approach to determining competency<a class="anchor" aria-label="anchor" href="#probabilistic-approach-to-determining-competency"></a>
</h4>
<p>One approach to modelling time-censored data is survival analysis,
which explicitly considers time-to-event outcomes. Applying this to the
settlement experiment, survival analysis becomes “time-to-settlement”
rather than “time-to-death”. Each experimental time point can be
considered as a census of 100-<em>n</em> larvae from the initial
starting pool, with individuals undergoing a binary transition where
swimming larvae = “0” and settled larvae = “1”. To estimate probability
of settlement through time, the data is fit with a Bayesian
discrete-time survival model with a Weibull distribution, resulting in
posterior distributions for shape and scale that accounts for
between-replicate variability in a multilevel framework.</p>
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#  fit &lt;- survfit(Surv(minutes, settled) ~ 1, data = df_long)</span></span>
<span><span class="co">#  ggsurvplot(fit, data = df_long, risk.table = TRUE)</span></span>
<span><span class="co">#  fitweibull &lt;- survreg(Surv(minutes, settled) ~ 1, data=df_long, dist='weibull')</span></span>
<span><span class="co">#  plot(survfit(Surv(minutes, settled) ~ 1, data = df_long)) </span></span>
<span><span class="co">#  curve(exp(-(exp(-fitweibull$coef[1]) * x)^(1/fitweibull$scale)), col="red", add=TRUE)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/" class="external-link">tidybayes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://modelr.tidyverse.org" class="external-link">modelr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span>  </span>
<span></span>
<span><span class="co"># convert cumulative sum of settled larvae to count data per individual (0 for not settled, 1 for settled) at each time point</span></span>
<span><span class="va">df_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">density</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/uncount.html" class="external-link">uncount</a></span><span class="op">(</span><span class="va">count</span>, .remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settled <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">count</span><span class="op">)</span>,</span>
<span>  <span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">density</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/uncount.html" class="external-link">uncount</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">-</span> <span class="va">count</span>, .remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settled <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">count</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Display the resulting data frame</span></span>
<span><span class="co"># df_uncount &lt;- df %&gt;% uncount(count)  %&gt;% </span></span>
<span><span class="co">#     mutate(count = 1)</span></span>
<span><span class="co"># df_swimming &lt;- df %&gt;% group_by(tile) %&gt;% mutate(count=100-count) %&gt;% uncount(count) %&gt;% mutate(count=0)</span></span>
<span><span class="co"># df_long &lt;- rbind(df_uncount, df_swimming)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># autoplot(survfit(Surv(minutes, count, type='right')~1,</span></span>
<span><span class="co">#   data = df_long), conf.int = T)</span></span>
<span></span>
<span></span>
<span><span class="co"># apply discrete-time survival model in brms specified with a Weibull distribution:</span></span>
<span><span class="va">event_model_weibull</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span><span class="va">minutes</span> <span class="op">|</span> <span class="fu">cens</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">settled</span><span class="op">)</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">w</span> <span class="op">|</span> <span class="va">tile</span><span class="op">)</span>, </span>
<span>  family <span class="op">=</span> <span class="va">weibull</span>, init <span class="op">=</span> <span class="fl">0</span>, </span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.99</span>, max_treedepth <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>  cores<span class="op">=</span><span class="fl">8</span>, chains<span class="op">=</span><span class="fl">4</span>, iter <span class="op">=</span> <span class="fl">10000</span>, data <span class="op">=</span> <span class="va">df_long</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">event_model_weibull</span>, <span class="st">"event_model_weibull.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">event_model_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span><span class="va">minutes</span> <span class="op">|</span> <span class="fu">cens</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">settled</span><span class="op">)</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">w</span> <span class="op">|</span> <span class="va">tile</span><span class="op">)</span>, </span>
<span>  family <span class="op">=</span>  <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsfamily.html" class="external-link">exponential</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>, init <span class="op">=</span> <span class="fl">0</span>,  </span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.99</span>, max_treedepth <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>  cores<span class="op">=</span><span class="fl">8</span>, chains<span class="op">=</span><span class="fl">4</span>, iter <span class="op">=</span> <span class="fl">10000</span>, data <span class="op">=</span> <span class="va">df_long</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">event_model_exp</span>, <span class="st">"event_model_exp.rds"</span><span class="op">)</span></span>
<span><span class="va">event_model_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"event_model_exp.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#plot(event_model_weibull)</span></span>
<span></span>
<span><span class="co"># Take the brm output (mu and shape), and extract scale: </span></span>
<span><span class="va">parameter_draws_weibull</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_df.html" class="external-link">as_draws_df</a></span><span class="op">(</span><span class="va">event_model_weibull</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">b_Intercept</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">shape</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># lambda</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">shape</span>, <span class="va">scale</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">parameter_draws_weibull</span>, <span class="st">"parameter_draws_weibull.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">parameter_draws_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_df.html" class="external-link">as_draws_df</a></span><span class="op">(</span><span class="va">event_model_exp</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="op">(</span><span class="va">b_Intercept</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># lambda</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">intercept</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/inv_logit_scaled.html" class="external-link">inv_logit_scaled</a></span><span class="op">(</span><span class="va">parameter_draws_exp</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.999157</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">parameter_draws_exp</span>, <span class="st">"parameter_draws_exp.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># saveRDS(post_sm1, "post_sm1.rds")</span></span>
<span> <span class="va">post_sm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/R code/markdown/post_sm1.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># resample the posterior draws, and create a 12hr time sequence, add predicted curve for each draw  </span></span>
<span><span class="co"># dataset &lt;- map(1:10000, function(i) {</span></span>
<span><span class="co">#   post_sm1_sample &lt;- post_sm1 %&gt;% slice_sample(n = 1)</span></span>
<span><span class="co">#   newdat &lt;- data.frame(minutes = seq(1, 620, 1)) %&gt;% </span></span>
<span><span class="co">#     mutate(settlement_probability = exp(-(minutes / post_sm1_sample$scale)^post_sm1_sample$shape)) %&gt;% </span></span>
<span><span class="co">#     mutate(id = i)</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#   return(newdat)</span></span>
<span><span class="co"># })</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">post_sm1_sample</span> <span class="op">&lt;-</span> <span class="va">post_sm1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">newdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>minutes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">620</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settlement_probability <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">minutes</span> <span class="op">/</span> <span class="va">post_sm1_sample</span><span class="op">$</span><span class="va">scale</span><span class="op">)</span><span class="op">^</span><span class="va">post_sm1_sample</span><span class="op">$</span><span class="va">shape</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">dataset</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">newdat</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># use rbinom to generate binary outcomes from probability at each timestep along each curve</span></span>
<span><span class="va">dataset_grouped</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">dataset</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">settlement_probability</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">#saveRDS(dataset_grouped, "dataset_grouped.rds")</span></span>
<span><span class="co">#dataset_grouped &lt;- readRDS("dataset_grouped.rds")</span></span></code></pre></div>
</details><p>The survival model is fit in brms (see code for details), where the
scale and shape parameters are resampled from the posterior draws using
<code>scale = exp(mu) / gamma(1 + 1/k).</code> Predictions of
time-to-competency for each individual were estimated from the Weibull
parameters (shape, scale) using the <code>rweibull</code> function for
each of the 10k posterior draws.</p>
<p>The plot below shows the model outputs: probability of settlement
from initial release to t12hrs. Thick black line represents the median
model output, thin lines represent 100 random draws from the posterior
(highlighting variability in predicted trajectories from the multilevel
approach).</p>
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sample 100 curves and plot against median</span></span>
<span><span class="va">dataset_grouped_subset</span> <span class="op">&lt;-</span> <span class="va">dataset_grouped</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">dataset_grouped_median</span> <span class="op">&lt;-</span> <span class="va">dataset_grouped</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">minutes</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>settlement_probability<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">settlement_probability</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># plot draws - highlights variance in predicted curves from including (1|tile) in survival model</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Hours after release"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Settlement Probability"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dataset_grouped_subset</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="va">settlement_probability</span>, group<span class="op">=</span><span class="va">id</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0.05</span>, color<span class="op">=</span><span class="st">"slategrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dataset_grouped_median</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="va">settlement_probability</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">1</span>, color<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> </span></code></pre></div>
<details><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot draws - highlights variance in predicted curves from including (1|tile) in survival model</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Hours after release"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Settlement Probability"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dataset_grouped_subset</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="va">settlement_probability</span>, group<span class="op">=</span><span class="va">id</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0.05</span>, color<span class="op">=</span><span class="st">"slategrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dataset_grouped_median</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="va">settlement_probability</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">1</span>, color<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="01-code-coralseed-main_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Predictions for time-to-settlement for parameterising dispersal
models (10<sup>5</sup> - 10<sup>6</sup> larvae) were obtained from draws
from the posterior. The figure below (a) is an example of 100 posterior
draws representing the probable time-to-settlement for 100 individual
(ordered) particle tracks with the median probability density function
of the Weibull fit. For the simulated population of <em>n</em>=100
larvae the model proximates the median fit, predicting 44% competence at
t12hrs (56% larvae remain in an incompetent state either to settle at a
later stage or undergo mortality).</p>
<p>The same dataset is visualised (below, figure b) as 1-dimensional
trajectories of the same population of 100 larvae, where green points
indicate the release of larvae at t0, and red points represent the
predicted competence time for an individual larvae. Transposing these
trajectories onto dispersal tracks, “competence” is used in the context
of “competent and able to settle” rather than “settled” in</p>
<p>The trajectories are used to parameterise spatiotemporal trajectories
by transposing a binary state (“not competent” vs “competent”) on
particle tracks from hydrodynamic models, which rephrases the question
“<em>when do larvae become competent</em>?” to “<em>where are larvae in
space when they become competent in time</em>?”</p>
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sample one probability from each of the 10k simulated curves from posterior draws</span></span>
<span></span>
<span><span class="va">bayesian_survival_preds_rweibull</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">post_sm1</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">post_sm1_i</span> <span class="op">&lt;-</span> <span class="va">post_sm1</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span></span>
<span>  <span class="va">post_sm1_i</span><span class="op">$</span><span class="va">minutes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html" class="external-link">rweibull</a></span><span class="op">(</span><span class="fl">1</span>, shape<span class="op">=</span><span class="va">post_sm1_i</span><span class="op">$</span><span class="va">shape</span>, scale<span class="op">=</span><span class="va">post_sm1_i</span><span class="op">$</span><span class="va">scale</span><span class="op">)</span> </span>
<span>  <span class="va">post_sm1_i</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">post_sm1_i</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>,<span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create predictions df for particletracking model</span></span>
<span><span class="va">bayesian_survival_preds_final</span> <span class="op">&lt;-</span> <span class="va">bayesian_survival_preds_rweibull</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">minutes</span>,<span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>minutes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">minutes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#saveRDS(bayesian_survival_preds_final, "bayesian_survival_preds_final_10k.rds")</span></span>
<span><span class="co">#bayesian_survival_preds_final &lt;- readRDS("bayesian_survival_preds_final_10k.rds")</span></span>
<span></span>
<span><span class="co"># subset to 100 ordered draws for plotting</span></span>
<span><span class="va">bayesian_survival_preds_rweibull_subset</span> <span class="op">&lt;-</span> <span class="va">bayesian_survival_preds_rweibull</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_head</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">minutes</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>minutes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">minutes</span> <span class="op">&gt;</span> <span class="fl">720</span>, <span class="cn">NA</span>, <span class="va">minutes</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">100</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">brm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span> <span class="op">+</span> <span class="co">#</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dataset_grouped_median</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="va">settlement_probability</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">"darkred"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">bayesian_survival_preds_rweibull_subset</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"hours"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Population (100 random draws)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># subset to 100 unordered draws for plotting, create segments df for geom_segments</span></span>
<span><span class="va">bayesian_survival_preds_rweibull_subset2</span> <span class="op">&lt;-</span> <span class="va">bayesian_survival_preds_rweibull</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_head</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>minutes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">minutes</span> <span class="op">&gt;</span> <span class="fl">720</span>, <span class="fl">720</span>, <span class="va">minutes</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settled <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">minutes</span> <span class="op">&lt;</span> <span class="fl">720</span>, <span class="st">"competent"</span>, <span class="st">"notcompetent"</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"competent"</span>, <span class="st">"notcompetent"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">segments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>start_x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span>, start_y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">100</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>, end_x<span class="op">=</span><span class="op">(</span><span class="va">bayesian_survival_preds_rweibull_subset2</span><span class="op">$</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span>, end_y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">100</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>, settled<span class="op">=</span><span class="va">bayesian_survival_preds_rweibull_subset2</span><span class="op">$</span><span class="va">settled</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">brm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">720</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">segments</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">start_x</span>, <span class="va">start_y</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"darkgreen"</span>, size<span class="op">=</span><span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">segments</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">end_x</span>, <span class="va">end_y</span>, color<span class="op">=</span><span class="va">settled</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">0.6</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">segments</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start_x</span>, y<span class="op">=</span><span class="va">start_y</span>, xend<span class="op">=</span><span class="va">end_x</span>, yend<span class="op">=</span><span class="va">end_y</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"slategrey"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>, alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"hours"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Population (100 random draws)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"competent"</span> <span class="op">=</span> <span class="st">"darkred"</span>, <span class="st">"notcompetent"</span> <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span><span class="va">brm1</span>,<span class="va">brm2</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#save(bayesian_survival_individual_predictions, file="/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/R code/outputs/bayesian_survival_individual_predictions.RData")</span></span></code></pre></div>
</details><p><img src="01-code-coralseed-main_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;"></p>
</details></details>
</div>
</div>
<div class="section level2">
<h2 id="individual-based-modelling-of-larval-dispersal-competency">2. Individual-based modelling of larval dispersal-competency<a class="anchor" aria-label="anchor" href="#individual-based-modelling-of-larval-dispersal-competency"></a>
</h2>
<p>The <code>coralseed</code> code leans heavily on
<code>sf</code>/<code>lwgeom</code> for processing data and spatially
mapping, and <code>tmap</code> to visualise the data (an updated v0.2
replaces <code>tidyverse</code> with <code>data.table</code> to speed
things up with large datasets).</p>
<p>The following example is based on a simulated larval release of 1k
particles for a 0-6 hour time window (15:00 to 21:00) at Lizard Island,
December 2021.</p>
<p>First, the model converts the imports data into <code>sf</code> as a
series of points for each individual particle track (<code>id</code>) at
12 minute time-steps from initial release:</p>
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/lwgeom/" class="external-link">lwgeom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap" class="external-link">tmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># download example dispersal model file </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="va">particle_points_json</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="st">"https://www.dropbox.com/s/yj44muabx8z2laf/run_day_11656_lizard_fcst_15_2611_93.json?raw=1"</span>, drivers <span class="op">=</span> <span class="st">"GeoJSON"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## options:        GeoJSON </span></span>
<span><span class="co">## Reading layer `OGRGeoJSON' from data source </span></span>
<span><span class="co">##   `https://www.dropbox.com/s/yj44muabx8z2laf/run_day_11656_lizard_fcst_15_2611_93.json?raw=1' </span></span>
<span><span class="co">##   using driver `GeoJSON'</span></span>
<span><span class="co">## Simple feature collection with 31000 features and 3 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XYZ</span></span>
<span><span class="co">## Bounding box:  xmin: 145.4448 ymin: -14.64841 xmax: 145.4568 ymax: -14.63941</span></span>
<span><span class="co">## z_range:       zmin: 1.95 zmax: 1.95</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># extract centroid for release point</span></span>
<span><span class="va">particle_points_zero</span> <span class="op">&lt;-</span> <span class="va">particle_points_json</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_zm.html" class="external-link">st_zm</a></span><span class="op">(</span><span class="va">particle_points</span>, drop <span class="op">=</span> <span class="cn">TRUE</span>, what <span class="op">=</span> <span class="st">"ZM"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># drop z</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html" class="external-link">ymd_hms</a></span><span class="op">(</span><span class="va">time</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_min</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>, n<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>time<span class="op">=</span><span class="va">time</span>, geometry <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># drops particles with points at t0 and replaces with new central start point to simulate a point release</span></span>
<span> </span>
<span><span class="va">particle_points_json_min_existing</span>  <span class="op">&lt;-</span> <span class="va">particle_points_json</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_zm.html" class="external-link">st_zm</a></span><span class="op">(</span><span class="va">particle_points</span>, drop <span class="op">=</span> <span class="cn">TRUE</span>, what <span class="op">=</span> <span class="st">"ZM"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># drop z</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html" class="external-link">ymd_hms</a></span><span class="op">(</span><span class="va">time</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#group_by(id) %&gt;%  # dropping as we want one central point not a new one for each....</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_min</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>, n<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time<span class="op">=</span><span class="va">particle_points_zero</span><span class="op">$</span><span class="va">time</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>geometry<span class="op">=</span><span class="va">particle_points_zero</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="va">particle_points_json_min_all</span>  <span class="op">&lt;-</span> <span class="va">particle_points_json</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_zm.html" class="external-link">st_zm</a></span><span class="op">(</span><span class="va">particle_points</span>, drop <span class="op">=</span> <span class="cn">TRUE</span>, what <span class="op">=</span> <span class="st">"ZM"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># drop z</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html" class="external-link">ymd_hms</a></span><span class="op">(</span><span class="va">time</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="co"># dropping as we want one central point not a new one for each....</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_min</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>, n<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time<span class="op">=</span><span class="va">particle_points_zero</span><span class="op">$</span><span class="va">time</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>geometry<span class="op">=</span><span class="va">particle_points_zero</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">particle_points_json_min_existing</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">particle_points_json_min_existing</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">mintime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">particle_points_json</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span></span>
<span><span class="va">particle_points_merged</span> <span class="op">&lt;-</span> <span class="va">particle_points_json</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_zm.html" class="external-link">st_zm</a></span><span class="op">(</span><span class="va">particle_points</span>, drop <span class="op">=</span> <span class="cn">TRUE</span>, what <span class="op">=</span> <span class="st">"ZM"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># drop z</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html" class="external-link">ymd_hms</a></span><span class="op">(</span><span class="va">time</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">time</span><span class="op">==</span><span class="va">mintime</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># drop the timepoints if they match the first time</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">particle_points_json_min_all</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">time</span><span class="op">)</span></span>
<span>  </span>
<span>   </span>
<span>  <span class="va">particle_points</span> <span class="op">&lt;-</span> <span class="va">particle_points_merged</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dispersaltime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">60</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">time</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs<span class="op">=</span><span class="fl">20353</span><span class="op">)</span> </span></code></pre></div>
</details><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">particle_points_json</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 6 features and 3 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XYZ</span></span>
<span><span class="co">## Bounding box:  xmin: 145.454 ymin: -14.64806 xmax: 145.4543 ymax: -14.64786</span></span>
<span><span class="co">## z_range:       zmin: 1.95 zmax: 1.95</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">##   id decay_value                time                       geometry</span></span>
<span><span class="co">## 1  0           1 2021-11-30 20:46:00 POINT Z (145.454 -14.64786 ...</span></span>
<span><span class="co">## 2  0           1 2021-11-30 20:57:00 POINT Z (145.4541 -14.64791...</span></span>
<span><span class="co">## 3  0           1 2021-11-30 21:09:00 POINT Z (145.4542 -14.64795...</span></span>
<span><span class="co">## 4  0           1 2021-11-30 21:21:00 POINT Z (145.4542 -14.64799...</span></span>
<span><span class="co">## 5  0           1 2021-11-30 21:33:00 POINT Z (145.4543 -14.64802...</span></span>
<span><span class="co">## 6  0           1 2021-11-30 21:45:00 POINT Z (145.4543 -14.64806...</span></span></code></pre>
<p><code>coralseed</code> spatially interpolates each particle to 1
minute time-steps across the trajectory and randomly samples from the
output of the Bayesian time-to-settlement model to determine a
probabilistic competency point (time in minutes following release) for
each particle. <code>points</code> are then connected to form
<code>paths</code> each particle <code>id</code> according to their
competency state through time (either <code>incompetent</code> or
<code>competent</code>).</p>
<p>Below is the dispersal time since release (minutes) and larval state
for 1000 individual larvae following release. For spatial reference, a
“restoratation hectare” boundary (100m x 100m) is overlaid on the centre
of the release site (red box).</p>
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set OSM map by the boundary of the particles +100m</span></span>
<span><span class="va">box</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">particle_points</span>, <span class="st">"EPSG:20353"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_convex_hull</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># at a 500m buffer around the points and set as outerlimits</span></span>
<span><span class="va">outer_limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">particle_points</span>, <span class="st">"EPSG:20353"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_convex_hull</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># set boundary_box limits </span></span>
<span><span class="va">maplims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">outer_limits</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="st">"EPSG:4326"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">maplims2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">outer_limits</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="st">"EPSG:20353"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">maplims3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">particle_points</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="st">"EPSG:20353"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create centroid for the release area</span></span>
<span><span class="va">particle_points_release_point</span> <span class="op">&lt;-</span> <span class="va">particle_points</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_min</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>, n<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="st">"EPSG:20353"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a 1 hectare plot (100m x 100m) surrounding the release area centroid</span></span>
<span><span class="va">particle_points_hectare</span> <span class="op">&lt;-</span> <span class="va">particle_points_release_point</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="fl">50</span>, nQuadSegs<span class="op">=</span><span class="fl">1</span>, endCapStyle <span class="op">=</span> <span class="st">"SQUARE"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Connect particles with paths grouped by id</span></span>
<span><span class="va">particle_paths</span> <span class="op">&lt;-</span> <span class="va">particle_points</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>do_union <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"LINESTRING"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">particle_points</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bayesian_survival_preds_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/R code/markdown/bayesian_survival_preds_final_10k.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># function to expand survival output into a expanded 1:720 minute * id dataframe</span></span>
<span><span class="va">bayesian_survival_preds_final_expanded</span> <span class="op">&lt;-</span> <span class="va">bayesian_survival_preds_final</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>n<span class="op">=</span><span class="va">n_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># take a random sample to match the n particle tracks</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dispersaltime <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">minutes</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">720</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">dispersaltime</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">dispersaltime</span> <span class="op">&lt;</span> <span class="va">minutes</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_id</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">720</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span><span class="co"># interpolate between particle points by 1 minute intervals and bind probability outputs</span></span>
<span><span class="co"># gives a position every 1 min and a column "state" from the brm model probability outputs (see above curve)</span></span>
<span><span class="va">particle_points_expanded</span> <span class="op">&lt;-</span> <span class="va">particle_points</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">decay_value</span>, <span class="op">-</span><span class="va">geometry</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">particle_points</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html" class="external-link">complete</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"1 mins"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approx</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">X</span>, <span class="va">time</span><span class="op">)</span><span class="op">$</span><span class="va">y</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approx</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">Y</span>, <span class="va">time</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dispersaltime<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">time</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">particle_points</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">bayesian_survival_preds_final_expanded</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"dispersaltime"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># join with probability </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">dispersaltime</span> <span class="op">==</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>competency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"1"</span> <span class="op">=</span> <span class="st">"competent"</span>, <span class="st">"0"</span> <span class="op">=</span> <span class="st">"incompetent"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">20353</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"POINT"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">particle_points_paths</span> <span class="op">&lt;-</span> <span class="va">particle_points_expanded</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">state</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># more than three points needed for line</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>do_union <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"LINESTRING"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>tracks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"1"</span> <span class="op">=</span> <span class="st">"competent"</span>, <span class="st">"0"</span> <span class="op">=</span> <span class="st">"incompetent"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>competency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">tracks</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"competent"</span>, <span class="st">"incompetent"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tmap_mode.html" class="external-link">tmap_mode</a></span><span class="op">(</span><span class="st">"view"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmap1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">outer_limits</span>, name<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NA</span>, lwd<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_paths</span>, name<span class="op">=</span><span class="st">"Particle tracks"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points</span>, name<span class="op">=</span><span class="st">"Particle points"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"dispersaltime"</span>, title <span class="op">=</span> <span class="st">"Dispersal (minutes)"</span>, palette<span class="op">=</span><span class="st">"Spectral"</span>, style <span class="op">=</span> <span class="st">"cont"</span>, id<span class="op">=</span><span class="st">"Dispersal time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_hectare</span>, name<span class="op">=</span><span class="st">"Restoration hectare"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"darkred"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">tmap2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">outer_limits</span>, name<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NA</span>, lwd<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_paths</span>, name<span class="op">=</span><span class="st">"Particle tracks"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"competency"</span>, title.lwd<span class="op">=</span><span class="fl">0</span>, lwd<span class="op">=</span><span class="fl">0.6</span>, palette<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue3"</span>, <span class="st">"seagreen4"</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_hectare</span>, name<span class="op">=</span><span class="st">"Restoration hectare"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"darkred"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tmap_options.html" class="external-link">tmap_options</a></span><span class="op">(</span>check.and.fix <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</details><div id="htmlwidget-5e58ddd8491904de5739" style="width:800px;height:400px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-5e58ddd8491904de5739">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-11.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script><div id="htmlwidget-2f0e9d84f5a8a2a2e88b" style="width:800px;height:400px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-2f0e9d84f5a8a2a2e88b">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-12.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script><p>As a quick check, the number of competent particles at the final
timepoint of the dispersal model (6hrs) is compared to a) Bayesian
survival model predictions and b) the raw experimental data:</p>
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">prop_settled</span> <span class="op">&lt;-</span> <span class="va">particle_points_expanded</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_tail</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># probability of larvae not settling</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># plot draws - highlights variance in predicted curves from including (1|tile) in survival model</span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Hours after release"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dataset_grouped_subset</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="va">settlement_probability</span>, group<span class="op">=</span><span class="va">id</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0.05</span>, color<span class="op">=</span><span class="st">"slategrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dataset_grouped_median</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="va">settlement_probability</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">1</span>, color<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="op">(</span><span class="va">prop_settled</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">0.4</span>, linetype<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">0.4</span>, linetype<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">6</span>,y<span class="op">=</span><span class="va">prop_settled</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>,colour<span class="op">=</span><span class="st">"red"</span>, size<span class="op">=</span><span class="fl">3</span>, alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">b2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Inverse competency (n/100)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Hours after release"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="fl">100</span><span class="op">-</span><span class="va">count</span>, color<span class="op">=</span><span class="va">tile</span><span class="op">)</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">minutes</span><span class="op">/</span><span class="fl">60</span>, y<span class="op">=</span><span class="fl">100</span><span class="op">-</span><span class="va">count</span>, fill<span class="op">=</span><span class="va">tile</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"black"</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span>, shape<span class="op">=</span><span class="fl">21</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set2"</span>, na.value<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set2"</span>, na.value<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="op">(</span><span class="va">prop_settled</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">0.4</span>, linetype<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">0.4</span>, linetype<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">6</span>,y<span class="op">=</span><span class="va">prop_settled</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span>,colour<span class="op">=</span><span class="st">"red"</span>, size<span class="op">=</span><span class="fl">4</span>, alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, <span class="st">'lines'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><p><img src="01-code-coralseed-main_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="simulating-larval-mortality">3. Simulating larval mortality<a class="anchor" aria-label="anchor" href="#simulating-larval-mortality"></a>
</h2>
<p>The model incorporates an additional step in calculating mortality
over particle trajectories. This mortality represents both natural
mortality (background mortality as larvae age) and some estimate of
predation by planktivores. As there’s no data to paramaterise the rate
or shape of this distribution, mortality over a 24hr period is estimated
based on survivorship curves: Type I (high survival in early stages,
increasing mortality for survivors), Type II (individuals die at a
constant rate regardless of their age), Type III (high mortality in
early stages, decrease in mortality for survivors). Type I mortality
would represent a scenario where larvae experience increasing mortality
with dispersal, while Type III would simulate a scenario where larvae
undergo intense predation prior to dispersing to the benthos.
Survivorship curves are fit with Weibull distribution parameterised with
“best-guess” shape and scale functions (see code for details), and
mortality is applied prior to determining settlement to reduce the
available pool of larvae. To visualise mortality, below is a simulation
of a 10% mortality rate across 1000 individuals (100 iterations) for
each of the mortality types:</p>
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_mortality_proportion</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">n_larvae</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">n_mortality</span> <span class="op">&lt;-</span> <span class="va">n_larvae</span><span class="op">*</span><span class="va">n_mortality_proportion</span></span>
<span></span>
<span><span class="va">survivorship_type</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">shape</span>, <span class="va">scale</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dispersaltime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1440</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">probabilities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html" class="external-link">dweibull</a></span><span class="op">(</span><span class="va">dispersaltime</span>, <span class="va">shape</span>, <span class="va">scale</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">dispersaltime</span>, size <span class="op">=</span> <span class="va">n</span>, prob <span class="op">=</span> <span class="va">probabilities</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Vectorized function to generate data frames for each iteration</span></span>
<span><span class="va">generate_sample</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">iter</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">typeI_time</span> <span class="op">&lt;-</span> <span class="fu">survivorship_type</span><span class="op">(</span><span class="va">n_mortality</span>, <span class="fl">2.5</span>, <span class="fl">1440</span><span class="op">)</span></span>
<span>  <span class="va">typeII_time</span> <span class="op">&lt;-</span> <span class="fu">survivorship_type</span><span class="op">(</span><span class="va">n_mortality</span>, <span class="fl">1.5</span>, <span class="fl">1440</span><span class="op">)</span></span>
<span>  <span class="va">typeIII_time</span> <span class="op">&lt;-</span> <span class="fu">survivorship_type</span><span class="op">(</span><span class="va">n_mortality</span>, <span class="fl">0.5</span>, <span class="fl">1440</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"typeI"</span>, <span class="st">"typeII"</span>, <span class="st">"typeIII"</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">n_mortality</span><span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">typeI_time</span>, <span class="va">typeII_time</span>, <span class="va">typeIII_time</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">time</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_mortality</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Use lapply to repeat the sampling for each individual and then bind the results together</span></span>
<span><span class="va">survivorship_loop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_mortality</span>, <span class="va">generate_sample</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"top"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">survivorship_loop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span><span class="op">/</span><span class="fl">60</span>, y <span class="op">=</span> <span class="va">n</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1.5</span>, alpha <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>, values <span class="op">=</span> <span class="fu">viridis</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1.0</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
</details><p><img src="01-code-coralseed-main_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="probability-landscapes-of-coral-settlement">4. Probability landscapes of coral settlement<a class="anchor" aria-label="anchor" href="#probability-landscapes-of-coral-settlement"></a>
</h2>
<p>To predict spatial patterns of larval settlement,
<code>coralseed</code> tracks particle <code>paths</code> across benthic
substrates to determine the probability of settlement based on i) larval
competency state, and ii) habitat electivity (based on substrate
quality).</p>
<p><code>coralseed</code> uses the <a href="https://allencoralatlas.org" class="external-link">Allen coral atlas</a> as a base
underlay for habitat types, but can be parameterised with any basemap
<code>shp</code> fles. Reef substrates available for coral settlement
were determined from the benthic Coral Atlas maps by excluding
non-settleable substrates (<em>microalgal mats</em>, <em>seagrass</em>,
and <em>sand)</em> and spatially joining settleable substrate
(<em>coral/algae</em> and <em>rubble</em>). Further iterations of the
model can explicitly consider post-settlement survival on rubble by
partitioning this as an additional substrate factor, but is merged in
v0.1 for simplicity. Settleable substrates were further delineated into
habitat types defined by the geomorphic Coral Atlas maps:</p>
<p><em>Back Reef Slope</em> • <em>Sheltered Reef Slope</em> •
<em>Plateau</em> • <em>Inner Reef Flat</em> • <em>Outer Reef Flat</em> •
<em>Reef Slope</em> • <em>Reef Crest</em></p>
<p><em>Shallow Lagoon</em> and <em>Deep Lagoon</em> habitats are
sediment dominated non-coral habitats and were excluded from the
geomorphic habitat maps prior to merging.</p>
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap" class="external-link">tmap</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1) Coral Atlas shp files </span></span>
<span><span class="va">benthic_map</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="st">"/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/R code/inputs/Lizard-plumes-20230421044150/Geomorphic-Map/geomorphic.geojson"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>class<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>class<span class="op">=</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_recode.html" class="external-link">fct_recode</a></span><span class="op">(</span><span class="va">class</span>, Lagoon <span class="op">=</span> <span class="st">"Shallow Lagoon"</span>, Lagoon <span class="op">=</span> <span class="st">"Deep Lagoon"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs<span class="op">=</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="st">"EPSG:20353"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reef_map</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="st">"/Users/rof011/Library/CloudStorage/OneDrive-CSIRO/Data - SeaSims/R code/inputs/Lizard-plumes-20230421044150/Benthic-Map/benthic.geojson"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>class<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">class</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Microalgal Mats"</span>, <span class="st">"Seagrass"</span>, <span class="st">"Sand"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs<span class="op">=</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="st">"EPSG:20353"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">allen_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">benthic_map</span>, <span class="va">reef_map</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_collection_extract.html" class="external-link">st_collection_extract</a></span><span class="op">(</span><span class="st">"POLYGON"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>habitat_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" "</span>, <span class="st">"_"</span>, <span class="va">class</span><span class="op">)</span>,<span class="st">"_"</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"%0"</span>,  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"d"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#saveRDS(allen_map, "allen_map.rds")</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">allen_map</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"black"</span>, lwd<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_fill</a></span><span class="op">(</span><span class="st">"class"</span>, name<span class="op">=</span><span class="st">"Benthic habitat"</span>, palette<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lagoon"</span> <span class="op">=</span> <span class="st">"cornsilk2"</span>,  <span class="st">"Back Reef Slope"</span><span class="op">=</span><span class="st">"darkcyan"</span>, <span class="st">"Reef Slope"</span><span class="op">=</span><span class="st">"darkseagreen4"</span>, <span class="st">"Sheltered Reef Slope"</span><span class="op">=</span><span class="st">"darkslategrey"</span>, <span class="st">"Inner Reef Flat"</span><span class="op">=</span><span class="st">"darkgoldenrod4"</span>, <span class="st">"Outer Reef Flat"</span><span class="op">=</span><span class="st">"darkgoldenrod2"</span>, <span class="st">"Reef Crest"</span><span class="op">=</span><span class="st">"coral3"</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tmap_options.html" class="external-link">tmap_options</a></span><span class="op">(</span>check.and.fix <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</details><div id="htmlwidget-138938c536e144227ee8" style="width:800px;height:800px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-138938c536e144227ee8">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-18.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script><div class="section level4">
<h4 id="substrate-electivity-larval-settlement">Substrate electivity &amp; larval settlement<a class="anchor" aria-label="anchor" href="#substrate-electivity-larval-settlement"></a>
</h4>
<p>Corals exhibit substrate preferences for settlement in lab and field
experiments that can be used to parameterise spatial maps of settlement
probability. For initial parameterisation of the model, data is
available for settlement tiles at North Reef (Lizard Island) for the
Reef Flat (2m depth), Reef Crest (2m depth) and reef slope (4-8m depth)
from Baird and Hughes 1998 and Baird unpublished data:</p>
<p><img src="01-code-coralseed-main_files/figure-html/unnamed-chunk-19-1.png" width="672"></p>
<p>Based on the above data, other GBR publications (Harriot 1985, Mundy
&amp; Babcock 1998, Baird 2001, Baird et al 2003, Doropoulos et al 2015)
and subjective decisions, v0.1 of <code>coralseed</code> was
parameterised according to the following settlement probabilities where
<em>P</em>=1 is absolute settlement and <em>P</em>=0 is no
settlement:</p>
<ul>
<li>“Reef Crest” - high settlement probability (<em>P</em> = 0.9 ±
0.1)</li>
<li>“Reef Slope” - high settlement probability (<em>P</em> = 0.9 ±
0.1)</li>
<li>“Sheltered Reef Slope” - lower than exposed habitats (<em>P</em> =
0.7 ± 0.1)</li>
<li>“Back Reef Slope” - lower in sheltered slope habitats (<em>P</em> =
0.6 ± 0.1)</li>
<li>“Outer Reef Flat” - half the settlement of reef crest/slope
(<em>P</em> = 0.45 ± 0.1)</li>
<li>“Inner Reef Flat” - senescent habitat, low settlement potential
(<em>P</em> = 0.3 ± 0.1)</li>
<li>“Plateau” - deep (&gt;10m) habitat, low probability of settlement
(<em>P</em> 0.2 ± 0.1)</li>
</ul>
<p>Habitat-specific settlement probabilities are then used to
parameterise spatial maps by sampling from a normal distribution of the
mean ± SE probability:</p>
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">benthic_probability</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Back Reef Slope"</span>, <span class="st">"Lagoon"</span>, <span class="st">"Inner Reef Flat"</span>, <span class="st">"Outer Reef Flat"</span>, </span>
<span>    <span class="st">"Plateau"</span>, <span class="st">"Reef Crest"</span>, <span class="st">"Reef Slope"</span>, <span class="st">"Sheltered Reef Slope"</span><span class="op">)</span>,</span>
<span>  means <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0</span>, <span class="fl">0.3</span>, <span class="fl">0.45</span>, <span class="fl">0.2</span>, <span class="fl">0.9</span>, <span class="fl">0.9</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>  se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">class_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="va">benthic_probability</span><span class="op">$</span><span class="va">means</span>, <span class="va">benthic_probability</span><span class="op">$</span><span class="va">class</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">allen_map_probability</span> <span class="op">&lt;-</span> <span class="va">allen_map</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">class</span><span class="op">==</span><span class="st">"Lagoon"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settlement_probability <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">class</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">class_means</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">benthic_probability</span>, by<span class="op">=</span><span class="st">"class"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settlement_probability <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">means</span>, <span class="va">se</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settlement_probability <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">settlement_probability</span> <span class="op">&gt;</span> <span class="fl">1</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">settlement_probability</span><span class="op">)</span>, <span class="va">settlement_probability</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">means</span>,<span class="op">-</span><span class="va">se</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#tmap_mode("view")</span></span>
<span></span>
<span><span class="va">allen1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">outer_limits</span>, name<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NA</span>, lwd<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">allen_map_probability</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"black"</span>, lwd<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_fill</a></span><span class="op">(</span><span class="st">"class"</span>, name<span class="op">=</span><span class="st">"Benthic habitat"</span>, </span>
<span>    palette<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lagoon"</span> <span class="op">=</span> <span class="st">"cornsilk2"</span>,  <span class="st">"Back Reef Slope"</span><span class="op">=</span><span class="st">"darkcyan"</span>, </span>
<span>      <span class="st">"Reef Slope"</span><span class="op">=</span><span class="st">"darkseagreen4"</span>, <span class="st">"Sheltered Reef Slope"</span><span class="op">=</span><span class="st">"darkslategrey"</span>, </span>
<span>      <span class="st">"Inner Reef Flat"</span><span class="op">=</span><span class="st">"darkgoldenrod4"</span>, <span class="st">"Outer Reef Flat"</span><span class="op">=</span><span class="st">"darkgoldenrod2"</span>, </span>
<span>      <span class="st">"Reef Crest"</span><span class="op">=</span><span class="st">"coral3"</span>, <span class="st">"Plateau"</span> <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tmap_options.html" class="external-link">tmap_options</a></span><span class="op">(</span>check.and.fix <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">allen2</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">outer_limits</span>, name<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NA</span>, lwd<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">allen_map_probability</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#  tm_fill(col="dispersaltime", palette="Spectral", style = "cont", id="Dispersal time") +</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_fill</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"settlement_probability"</span>, style <span class="op">=</span> <span class="st">"cont"</span>, alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"black"</span>, lwd<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tmap_options.html" class="external-link">tmap_options</a></span><span class="op">(</span>check.and.fix <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</details><div id="htmlwidget-8000c53b7b285deb5333" style="width:800px;height:400px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-8000c53b7b285deb5333">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-21.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script><div id="htmlwidget-18bdc0cbaacffa668263" style="width:800px;height:400px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-18bdc0cbaacffa668263">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-22.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level4">
<h4 id="probabilistic-settlement-across-particle-paths">Probabilistic settlement across particle paths<a class="anchor" aria-label="anchor" href="#probabilistic-settlement-across-particle-paths"></a>
</h4>
<p><code>coralseed</code> takes the particle paths (below Fig a) and
maps settlement probability for each <code>id</code> according to
habitats encountered along each trajectory (below Fig b).</p>
<details><summary align="right"><b>Show Code</b>
</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create merged points, bind output with probability</span></span>
<span><span class="va">particle_points_probability</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">particle_points_expanded</span>, <span class="va">allen_map_probability</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>class <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_na_value_to_level.html" class="external-link">fct_na_value_to_level</a></span><span class="op">(</span><span class="va">class</span>, <span class="st">"Ocean"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># replace NA with Ocean</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>habitat_id <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_na_value_to_level.html" class="external-link">fct_na_value_to_level</a></span><span class="op">(</span><span class="va">habitat_id</span>, <span class="st">"Ocean"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># replace NA with Ocean</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settlement_probability <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">settlement_probability</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># make lagoon and ocean 0</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settlement_outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, </span>
<span>      size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">settlement_probability</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">#turn into probability  </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settlement_outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">settlement_outcome</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>final<span class="op">=</span><span class="va">state</span><span class="op">*</span><span class="va">settlement_outcome</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">state</span><span class="op">*</span><span class="va">settlement_outcome</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create linestrings for each ID with tracks by status (for visualisation)</span></span>
<span><span class="va">particle_points_paths_competency</span> <span class="op">&lt;-</span> <span class="va">particle_points_probability</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">competency</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># more than three points needed for line</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>do_union <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"MULTILINESTRING"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create linestrings for each ID with tracks by status (for visualisation)</span></span>
<span><span class="va">particle_points_paths_probability</span> <span class="op">&lt;-</span> <span class="va">particle_points_probability</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">settlement_probability</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>settlement_probability <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">settlement_probability</span><span class="op">==</span><span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">settlement_probability</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">settlement_probability</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># more than three points needed for line</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>do_union <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"LINESTRING"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmaptracksplasma</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">outer_limits</span>, name<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NA</span>, lwd<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_paths_competency</span>, name<span class="op">=</span><span class="st">"Settlement Probability"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">0.8</span>, col<span class="op">=</span><span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_paths_probability</span>, name<span class="op">=</span><span class="st">"Settlement Probability"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span><span class="st">"settlement_probability"</span>, style<span class="op">=</span><span class="st">"cont"</span>, lwd<span class="op">=</span><span class="fl">0.8</span>, palette<span class="op">=</span><span class="st">"-plasma"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_hectare</span>, name<span class="op">=</span><span class="st">"Restoration hectare"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"darkred"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmaptrackscompetency</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">outer_limits</span>, name<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NA</span>, lwd<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_paths_competency</span>, name<span class="op">=</span><span class="st">"Competency"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span><span class="st">"competency"</span>, lwd<span class="op">=</span><span class="fl">0.8</span>, palette<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"lightblue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_hectare</span>, name<span class="op">=</span><span class="st">"Restoration hectare"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"darkred"</span><span class="op">)</span></span></code></pre></div>
</details><div id="htmlwidget-bbc1d2b8a793e49f5dfe" style="width:800px;height:400px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-bbc1d2b8a793e49f5dfe">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-24.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script><div id="htmlwidget-a5f9e70a27b4cc7e4690" style="width:800px;height:400px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-a5f9e70a27b4cc7e4690">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-25.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script><p>Note that this <em>isn’t</em> the probability of settlement but the
probability of settlement <em>if</em> the larvae are competent. To get
this, <code>coralseed</code> combines the probabilities to get an
outcome for each particle (i.e. a single settlement point). When a
competent particle passes a suitable habitat for settlement,
<code>coralseed</code> calculates the probability of settlement in each
time-step as additive not multiplicative: larvae have the same
probability of settlement whether they remain within the habitat for 5
minutes or 30 minutes. Spatially, <code>coralseed</code> assigns the
larvae to a random point along the path in the habitat once settlement
is determined to avoid immediate settlement on the boundaries of
suitable habitats. The <code>settle_particles</code> function offers
three approaches to probabilistic settlement: additive (where particles
settle at random along the trajectory within the habitat if p=1), rapid
(where particles settle immediately if p=1 - within the first available
timestep), and lagged (where particles settle within the first 5 minutes
of the trajectory if p=1).</p>
<p>Typically, dispersal models include a “halo” around reefs that if
particles pass through, then larvae are allocated to that reef.
Spatially this is straightforward to implement in <code>sf</code> by
assigning spatial buffers around habitats that have greater settlement
probability (e.g. “Reef Slope” habitats draw any particles passing
within 30m spatial distance). For spatially realistic models this
approach is problematic as larvae can then settle within spatial buffers
outside of the actual habitat. v2.0 of <code>coralseed</code> gets
around this issue by using <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">sf::st_snap</a></code> to “capture”
particles that pass by habitats and then randomly assigning settlement
within the habitat, but the approach is computationally expensive
(iterates across all points and habitats) and needs refining to make it
workable. While difficult to parameterise, the adding halos in v2.0 will
increase the likelihood of settlement in areas of high retention and
will be updated.</p>
</div>
</div>
<div class="section level2">
<h2 id="spatial-patterns-of-settlement">5. Spatial patterns of settlement<a class="anchor" aria-label="anchor" href="#spatial-patterns-of-settlement"></a>
</h2>
<div class="section level4">
<h4 id="final-output">Final output<a class="anchor" aria-label="anchor" href="#final-output"></a>
</h4>
<p>Of the initial 1000 larvae that were released in the current example,
102 larvae reached competency and settled on substrates within a 6hr
window. Below is a map of the final settlement points and prior
trajectories overlaid with the same 1 hectare settlement box:</p>
<details><summary><b>Show Code</b>
</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create final settlement points following succesful settlement on substrates</span></span>
<span></span>
<span><span class="co">#select the first habitat per ID</span></span>
<span><span class="va">particle_points_outcome</span> <span class="op">&lt;-</span> <span class="va">particle_points_probability</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">==</span><span class="st">"1"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># select settled particles</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">id</span>,<span class="va">time</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">habitat_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># sample one random point per habitat_id</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">id</span>,<span class="va">dispersaltime</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_head</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># take first of the habitats by dispersaltime if multiple intersects</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">class</span>, <span class="va">time</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cat<span class="op">=</span><span class="st">"settled"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cat</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">particle_points_outcome_time</span> <span class="op">&lt;-</span> <span class="va">particle_points_outcome</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>cat2<span class="op">=</span><span class="va">cat</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">time</span>, <span class="va">cat2</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">particle_points_outcome_paths</span> <span class="op">&lt;-</span> <span class="va">particle_points_probability</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">.</span>,<span class="va">particle_points_outcome_time</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html" class="external-link">fill</a></span><span class="op">(</span><span class="va">cat2</span>, .direction <span class="op">=</span> <span class="st">"up"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="va">cat2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">cat2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>do_union <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"MULTILINESTRING"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmpa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_outcome</span>, name<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.000001</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">allen_map</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"black"</span>, lwd<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_fill</a></span><span class="op">(</span><span class="st">"class"</span>, name<span class="op">=</span><span class="st">"Benthic habitat"</span>, </span>
<span>    palette<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lagoon"</span> <span class="op">=</span> <span class="st">"cornsilk2"</span>,  <span class="st">"Back Reef Slope"</span><span class="op">=</span><span class="st">"darkcyan"</span>, </span>
<span>      <span class="st">"Reef Slope"</span><span class="op">=</span><span class="st">"darkseagreen4"</span>, <span class="st">"Sheltered Reef Slope"</span><span class="op">=</span><span class="st">"darkslategrey"</span>, </span>
<span>      <span class="st">"Inner Reef Flat"</span><span class="op">=</span><span class="st">"darkgoldenrod4"</span>, <span class="st">"Outer Reef Flat"</span><span class="op">=</span><span class="st">"darkgoldenrod2"</span>, </span>
<span>      <span class="st">"Reef Crest"</span><span class="op">=</span><span class="st">"coral3"</span>, <span class="st">"Plateau"</span> <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_outcome_paths</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_outcome</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"aquamarine3"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_hectare</span>, name<span class="op">=</span><span class="st">"Restoration hectare"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"darkred"</span><span class="op">)</span></span></code></pre></div>
</details><div id="htmlwidget-10e3902ba90a5cf332e4" style="width:800px;height:800px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-10e3902ba90a5cf332e4">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-27.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level4">
<h4 id="quantifying-settlement-densities">Quantifying settlement densities<a class="anchor" aria-label="anchor" href="#quantifying-settlement-densities"></a>
</h4>
<p><code>coralseed</code> generates a spatial grid from the outer
boundaries of the settlement points according to a fixed grid-cell size
(below = 20m cells), and calculates the density of larvae in each
grid-cell:</p>
<details><summary><b>Show Code</b>
</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make a spatial grid across the settled particles, set cell size (metres)</span></span>
<span><span class="va">particle_points_grid</span> <span class="op">&lt;-</span> <span class="va">particle_points_outcome</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span>, <span class="op">-</span><span class="va">class</span>, <span class="op">-</span><span class="va">time</span>, <span class="op">-</span><span class="va">cat</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html" class="external-link">st_make_grid</a></span><span class="op">(</span>cellsize <span class="op">=</span> <span class="fl">20</span>, what <span class="op">=</span> <span class="st">"polygons"</span><span class="op">)</span>  <span class="co"># 20metre grid</span></span>
<span></span>
<span><span class="co"># calculate the density of larvae within each grid-cell, convert to sf</span></span>
<span><span class="va">grid_count</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html" class="external-link">over</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html" class="external-link">as_Spatial</a></span><span class="op">(</span><span class="va">particle_points_grid</span><span class="op">)</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html" class="external-link">as_Spatial</a></span><span class="op">(</span><span class="va">particle_points_outcome</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">class</span><span class="op">)</span><span class="op">)</span>, fn <span class="op">=</span> <span class="va">length</span><span class="op">)</span> </span>
<span><span class="va">particle_points_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">particle_points_grid</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>density<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">grid_count</span><span class="op">$</span><span class="va">id</span>,<span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">tmap_grid1</span> <span class="op">&lt;-</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_grid</span>, projection <span class="op">=</span> <span class="fl">20353</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">0.2</span>, col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_outcome</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"aquamarine3"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_hectare</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.3</span>, lwd<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"darkred"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmap_grid2</span> <span class="op">&lt;-</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_grid</span>, projection <span class="op">=</span> <span class="fl">20353</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_fill</a></span><span class="op">(</span><span class="st">"density"</span>,  colorNA<span class="op">=</span><span class="st">"transparent"</span>, palette<span class="op">=</span><span class="st">"plasma"</span>, alpha<span class="op">=</span><span class="fl">0.6</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">0.2</span>, col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_hectare</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.3</span>, lwd<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"darkred"</span><span class="op">)</span></span></code></pre></div>
</details><div id="htmlwidget-904ae73ddf77530373e5" style="width:800px;height:400px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-904ae73ddf77530373e5">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-29.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script><div id="htmlwidget-d5dd3f5783561b3c3f66" style="width:800px;height:400px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-d5dd3f5783561b3c3f66">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-30.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script><p>Alternatively, <code>coralseed</code> can quantify the settlement by
the proportion of initial larvae (below at a finer 5m cellsize), which
is the % of the 1k initial larvae released in the dispersal model.</p>
<details><summary><b>Show Code</b>
</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make a spatial grid across the settled particles, set cell size (metres)</span></span>
<span><span class="va">particle_points_grid</span> <span class="op">&lt;-</span> <span class="va">particle_points_outcome</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span>, <span class="op">-</span><span class="va">class</span>, <span class="op">-</span><span class="va">time</span>, <span class="op">-</span><span class="va">cat</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html" class="external-link">st_make_grid</a></span><span class="op">(</span>cellsize <span class="op">=</span> <span class="fl">5</span>, what <span class="op">=</span> <span class="st">"polygons"</span><span class="op">)</span>  <span class="co"># 20metre grid</span></span>
<span></span>
<span><span class="co"># calculate the density of larvae within each grid-cell, convert to sf</span></span>
<span><span class="va">grid_count</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html" class="external-link">over</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html" class="external-link">as_Spatial</a></span><span class="op">(</span><span class="va">particle_points_grid</span><span class="op">)</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html" class="external-link">as_Spatial</a></span><span class="op">(</span><span class="va">particle_points_outcome</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">class</span><span class="op">)</span><span class="op">)</span>, fn <span class="op">=</span> <span class="va">length</span><span class="op">)</span> </span>
<span><span class="va">particle_points_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">particle_points_grid</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>density<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">grid_count</span><span class="op">$</span><span class="va">id</span>,<span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>proportion<span class="op">=</span><span class="va">density</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmap_grid3</span> <span class="op">&lt;-</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html" class="external-link">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_grid</span>, projection <span class="op">=</span> <span class="fl">20353</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_fill</a></span><span class="op">(</span><span class="st">"proportion"</span>,  colorNA<span class="op">=</span><span class="st">"transparent"</span>, palette<span class="op">=</span><span class="st">"plasma"</span>, alpha<span class="op">=</span><span class="fl">0.6</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">0.2</span>, col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">particle_points_hectare</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.3</span>, lwd<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"darkred"</span><span class="op">)</span></span></code></pre></div>
</details><div id="htmlwidget-e6eca7e92718519e250e" style="width:800px;height:400px;" class="widgetframe html-widget "></div>
<script type="application/json" data-for="htmlwidget-e6eca7e92718519e250e">{"x":{"url":"/Users/rof011/coralseed/docs/articles/01-code-coralseed-main_files/figure-html//widgets/widget_unnamed-chunk-32.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level4">
<h4 id="notes">notes<a class="anchor" aria-label="anchor" href="#notes"></a>
</h4>
<p>The above implementation for <code>coralseed</code> is based on 1k
particles. To run larger models, <code>coralseed</code> has been tested
with geojson files of up to 10k particles, but with the sf framework
will handle larger inputs. As probabilities are generated dynamically
with each iteration (i.e. competency, settlement probability) by drawing
from the posteriors of the Bayesian models, <code>coralseed</code> can
be run iteratively with the same input to incorporate estimates of
variance. For example,</p>
<p>100 loops across an input of 10k larvae will generate settlement
probabilities for 1 million individuals (100 individuals per path). See
parallel processing for details.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by George Roff.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
